name: Check M3U Playlist Streams

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:  # Allows manual triggering
  push:
    branches:
      - main  # Runs on push to main branch

jobs:
  check-m3u-streams:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'  # Specify Python version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run M3U stream checker
        env:
          PLAYLIST_URL: 'https://raw.githubusercontent.com/moajzim47/moajzimofficials/9902d23e34d9c7a747ff2846d78e1c4151252df9/It%27s-Unique-Hex-MoAj-STREAMZ-PLAY.M3U'
        run: |
          python check_m3u.py --url "$PLAYLIST_URL" --output m3u_playlist_check_results.txt --workers 10 --timeout 10

      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: m3u-check-results
          path: m3u_playlist_check_results.txt
          retention-days: 7

      - name: Commit and push results
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add m3u_playlist_check_results.txt m3u_check.log
          git commit -m "Update M3U stream check results - $(date -u)"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'M3U Stream Check Failed',
              body: 'The M3U stream checker workflow failed. Please check the logs for details.'
            })
